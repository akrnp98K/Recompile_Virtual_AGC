# Recompile_Virtual_AGC
A repaired recompilation based on NASA's 1969 Apollo program onboard computer system source code

# Virtual AGC

## 介绍

该项目提供了1969年人类首次登月时的阿波罗11号飞船搭载的机载制导计算机的计算机模拟阿波罗计划的登月任务—主要是阿波罗指挥舱和月球中使用的制导计算机（AGC）模块。



# 什么是“AGC”、”Block I II“、”AGS“、”LVDS“、”OBC“

## AGC

**“AGC”**代表**Apollo Guidance Computer**。AGC是 NASA阿波罗任务的主要机载计算机，包括所有登月所需数据的计算模块、命令模块 （CM） 和 登月舱（LM），因此大多数阿波罗任务中都使用了该计算机，但可能使用了不同的软件。AGC及其软件由麻省理工学院团队开发，现在称为Draper实验室。

## Block II

采用AGC4指令集的“block II”，是主要的AGC计算机模型。block II AGC 不仅用于阿波罗 7 号到阿波罗 17 号包括所有实际登月，还用于三个轨道空间站任务、阿波罗-联盟号测试任务以及使用 F-8 飞行器的电传操纵研究项目。然而，当年只建造了 57 个 AGC，以及 138 个显示键盘单元 (DSKY)，而且所有安装在登月舱中的 AGC 都没有返回地球。

## Block I

“block I”模型服务于任务初期的 AGC ，它早于 block II 模型。Block I模型本来应该在阿波罗1号和2号上飞行。但是阿波罗1号不幸被大火烧毁，而阿波罗2号从未飞行过，因此Block I模型从未在任何载人任务中使用过。尽管如此，它还是被用于无人阿波罗 3、4 和 6 号任务。

## AGS

"**AGS**"代表**AbortGuidanceSystem** 系统，其中计算机部分被称为中止电子组件（AEA）。AGS/AEA 是与 AGC 完全独立的计算机系统，具有不同的体系结构、不同的指令集、不同的运行时软件，并且由与 AGC 不同的团队设计与制造。它在登月舱中作为 AGC 的一种备份，但只应该在着陆中止的情况下使用。它的唯一任务是让登月舱从任何地方回到月球轨道，以便CM可以与登月舱对接。

## LVDC

LVDC ” （**Launch Vehicle Digital Computer**）它与前面的系统有不同的架构、指令集、软件和制造商。它是安装在土星五号火箭本身的一台计算机，其职责是控制火箭发动机的点火，为火箭提供正确的轨道。当 CSM 丢弃火箭时，它也被丢弃，因此相对于任务总长度来说，它只在非常短的时间间隔内使用。

## OBC

OBC，双子座飞船的机载计算机，具有与阿波罗 AGC 类似的功能，尽管功能和复杂程度大大降低，但其计算机架构与阿波罗 LVDC 非常相似。

# 什么是“Virtual AGC”

**Virtual AGC**是AGC的计算机模型。它并不是模仿 AGC 的 *表面行为特征，而是基于上世纪六十年代的阿波罗计划中计算机项目的源代码存档对 AGC 的内部工作原理进行建模。生产的结果是 AGC 的计算机模型，它本身能够在例如： PC 上执行原始 Apollo 软件。

> 由于年代久远部分源代码指令以及不被现今的CPU支持，我对其进行了部分重写。

Virtual AGC 的当前版本设计为可在 Linux、Microsoft Windows 和 Mac OS X 以及某些版本的 FreeBSD 中运行。

 # Virtual AGC 项目包含的模块



+ **yaAGC** ：AGC CPU 的仿真。为了发挥作用，它需要 LM 或 CM“核心绳（内存）”二进制文件”（见下文）。

+ **yaDSKY**：Apollo 中使用的显示器/键盘的模拟。它向**yaAGC**提供输入，或接收来自它的输出。仿真器的设计是模块化的，因此对现有的原始仿真器不满意，或者如果想将其替换为完整的控制面板仿真，则可以使用API轻松替换 DSKY 仿真。
+ **LM_Simulator**是各种其他制导和导航 (G&N) 系统组件的模拟，例如惯性测量单元 (IMU)、FDAI 球、替代模拟 DSKY 以及 AGC I/O 通道活动的监视器。 

- **yaTelemetry**是一个哑终端，可以在其上查看来自**yaAGC**的遥测下行链路，类似于任务控制最初查看来自 AGC 的遥测数据的方式。
- **yaACA**是一个模拟 LM 手动控制器（部分Module带有操纵杆）的程序，并将所需的俯仰/滚动/偏航变化传达给**yaAGC**。
- **yaYUL**是一个汇编程序，能够将 AGC4 汇编语言程序（如**Luminary**或**Colossus** （见下文））转换为 AGC 所需的二进制可执行格式（“核心绳”）。
- **Luminary**是阿波罗登月舱在实际任务中使用的 1960 年代和 1970 年代原始软件的名称。提供了二进制可执行文件（**yaAGC**需要）和源代码（ **yaYUL**需要）。项目有很多版本的软件，用于不同的任务。
- **Colossus**是 1960 年代和 1970 年代原始软件的名称，用于许多（但不是全部）阿波罗命令模块。与**Luminary**一样，提供了二进制文件和源代码，并且有很多版本的软件。
- **Verify**是一个新创建的 AGC 汇编语言程序的名称，它提供了一个验证套件来确保虚拟 CPU 的实现是正确的。



# 运行模拟器

该项目讨论的只是如何运行该项目直接提供的纯虚拟 AGC 软件。如果想使用[NASSP 附加组件运行像](https://github.com/dseagrav/NASSP/tree/master)[Orbiter](http://orbit.medphys.ucl.ac.uk/)这样的完整航天器模拟，则必须查看 NASSP 文档。 当然，第一步是下载 Virtual AGC 软件并按照下载页面上的说明进行安装或针对您正在使用的计算机平台进行构建。

运行项目bin目录中的**VirtualAGC.exe**会得到下面的窗口

![MainGUI](http://www.ibiblio.org/apollo/Screenshot-VirtualAGC.jpg)

这是程序的唯一窗口 。没有菜单、工具栏、热按钮或其他控件。虽然提供了大量选项，但通常不需要更改任何选定的选项。默认值如图所示，只需单击“RUN！” 单击窗口底部的按钮，将运行模拟。但先不要这么做，因为下面还有验证步骤。

# 快速开始

## 运行验证套件

有一个“验证套件”，它是用 AGC 汇编语言编写的，它将检查每个 CPU 指令是否在 AGC 模拟器中正确执行。

1. 如上所述运行**VirtualAGC ，在最左侧“Simulation Type”区域中选择“Validation Suite”选项，然后单击“RUN！”** 按钮。
2. 在 DSKY 上，你将看到 00 出现在 PROG 和 NOUN 字段中，并且 OPR ERR 指示灯将亮起。这意味着验证程序已准备好启动。按 DSKY 的 PRO 键启动程序。OPR ERR 指示灯将关闭，表示命令已被接受。
3. 几十秒后，PROG 字段中将出现 77，并且 OPR ERR 指示灯将亮起。如果 PROG 字段中出现 77 以外的任何内容，则 PROG 和 NOUN 字段中的数字将指示测试的哪个区域失败。（之后可以再次按 PRO 继续进行其余测试。但通常没有必要）

# DSKY的简单操作说明

| <img src="http://www.ibiblio.org/apollo/V05N09E-thm.png" style="zoom:200%;" /> | 查看警报代码             | 由于目前我初始化 Colossus 的方式存在一些错误，启动时会有一些程序警报，并且 PROG 指示灯会亮起以通知你。可以在 DSKY 中输入 V05N09E 查看警报。（在正常的AGC简写中，“V”是“VERB”的缩写，“N”是“NOUN”的缩写，“E”是“ENTR”的缩写。所以“V05N09E”意思是敲击按键VERB 0 5 NOUN 0 9 ENTR。）程序警报1105和1106是“下行链路太快”和“上行链路太快”<br>上行链路或下行链路是指与地面设备交换遥测信息 |
| ------------------------------------------------------------ | ------------------------ | :----------------------------------------------------------- |
| ![LightTest](http://www.ibiblio.org/apollo/V35E-thm.png)     | DSKY指示灯及其显示器测试 | 在 DSKY 中，输入 V35E。将点亮所有 DSKY 信号器，闪烁动词/名词标签，并在所有数字寄存器中显示 88 或 +88888。大约 5 秒后，测试结束。 |
| ![](http://www.ibiblio.org/apollo/V91E-thm.png)              | 显示内存组校验和         | 核心绳（只读）存储器分为 36 个组，编号为 00-43（八进制）。每个组的末尾都贴有一个所谓的“bugger word”——“NASA称之为校验和”——这使得内存组的校验和得出一个已知值。如果可能的话，该已知值与存储体编号相同，否则是存储体编号的逻辑补码。（例如，**Colossus** 00007 号组的校验和为 00007，但 00006 号组的校验和为 77771。两者都是正确的。 项目中的“show-banksum”程序可用于一一显示组号码。可以通过在 DSKY 上键入 V91E 来执行 show-banksum 程序。几秒钟后，将显示组 00 的统计数据： R1（最上面的 5 位显示）将包含计算出的校验和；R2 将包含组号码；R3 将包含 bugger word。如果+/- 符号为空白则每个显示都将以八进制显示，键入 V33E，可以前进到下一个库（按 PRO 键会执行相同的操作。）如果您有耐心推进每个存储体，则存储体 43 之后的下一个 V33E（或 PRO）将再次环绕到存储体 00。最后，显示的bank-6 bugger字（05143）是针对Colossus 249的。如果你运行Artemis 072程序，它会是04275，而如果你运行Luminary 131程序，它会是63402。 |
| ![](http://www.ibiblio.org/apollo/V16N36E-thm.png)           | 监控当前时间             | 如果输入V16N36E或V16N65E，将会显示当前时间。（由于没有以任何方式设置时间，这将是自 AGC 上电启动以来的时间）。R1（最上面的 5 位数字显示）将以小时为单位，R2 以分钟为单位，R3 以百分之一秒为单位。该显示每秒更新一次。<br>在随附的截图中，时间为 06:58:33.86。 |
| ![](http://www.ibiblio.org/apollo/V25N36E-thm.png)           | 设置当前时间             | 如果想要更改开机后的时间，可以通过输入 V25N36E 来更改时间（例如，任务时间）。R1 将变为空白，使你能够键入当前时间。确保以 + 号开头（AGC 通过这种方式识别使用的是十进制而不是八进制），并确保输入所有五位数字（包括前导零）。如果输入错误i，可以在按 ENTR 之前随时使用 CLR 键清除 R1。按ENTR键后，R2将清除，你可以输入当前分钟数。最后，可以在 R3 中键入秒数（秒数实际上是百分之一秒） |
| ![](http://www.ibiblio.org/apollo/V27N02E4000E-thm.png)      | 检查可擦除存储器的内容   | 输入 V01N02E。这会将可擦除存储器中的字地址输入到 R3 中。可擦除存储体 E0 的地址为 00000-00377，存储体 E1 的地址为 00400-00777，依此类推，存储体 E7 的地址为 03400-03777。或者，使用 VERB 11来“监视”内存位置（即每秒获取一次更新）。例如，V11N02E25E 将监视寄存器 25，即“TIME1”寄存器，它是一个每 10 ms 递增的内部计数器。当然，一般来说，除非参考 源文件中的Colossus 249 装配清单，否则这些数字没有多大意义。 |
| ![](http://www.ibiblio.org/apollo/V21N02E25E-thm.png)        | 更改可擦除存储器的内容   | 输入V21N02E，并输入如上所示的八进制地址，然后输入要存储在该地址的新值。不多bb，当你这样做时，你最好知道自己在做什么。<br>在随附的屏幕截图中，我选择使用值 12345（八进制）重新加载 TIME1 寄存器，这不会造成太多不利影响。显示 R2 没有更改，因为它只包含之前包含的内容。 |
| ![](http://www.ibiblio.org/apollo/V36E-thm.png)              | 全新的开始               | 输入V36E。这会重新启动“pinball”程序（即负责接受动词V和名词N并在 DSKY 上显示内容的程序），它对于清除 DSKY 显示屏上的垃圾很有用，如随附的屏幕截图所示。 |
|                                                              | 更多指令                 | 文件 yaAGC/Colossus249/ASSEMBLY_AND_OPERATION_INFORMATION.s 列出了动词和名词表，你可以参照其中的内容来执行接下来的任务。 |

# 基础的演示

# 尝试一个AGC启动流程清单

下面演示一个基于阿波罗13号任务的启动流程。

| Step | Active                    | description                                                  | PNG                                                          |
| ---- | ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 0x00 | 运行模拟器                | 如上所述运行**Virtual AGC** ，在**“Simulation Type”**区域中选择“阿波罗13号登月舱”，然后点击**“RUN”** | ![](http://www.ibiblio.org/apollo/LMV36E-thm.png)            |
| 0x01 | V35E                      | 开始 DSKY 灯测试。所有指示灯亮起，数字显示屏显示 88 或 +888888，以及部分应该闪烁的东西。大约 5 秒后，灯测试会自动终止。 | ![](http://www.ibiblio.org/apollo/LMV35E-thm.png)            |
| 0x02 | V37E 00E                  | “Goto Pooh” — 启动程序P00空闲程序。PROG 标签下的数字区域将显示 00。 | ![](http://www.ibiblio.org/apollo/V37E00E-thm.png)           |
| 0x03 | V25E N01E 01365E 0E 0E 0E | 初始化计数器，将失败自检总数、已开始自检总数和成功完成分区测试的计数设置为 0。 | ![](http://www.ibiblio.org/apollo/V25N01E1365E0E0E0E-thm.png) |
| 0x04 | V15 N01E 01365E           | 开始监控自检计数。R1（顶部 5 位显示）显示失败测试的数量，R2 显示已开始测试的数量，R3 表示已完成划分测试的数量。每个应该是+00000（“所有位”）。 | ![](http://www.ibiblio.org/apollo/V15N01E1365E-thm.png)      |
| 0x05 | V21 N27E 10E              | 开始后台自检。这些测试将持续进行，直到你终止。但至少应该持续到开始测试的数量 (R2) 达到 3。 | ![](http://www.ibiblio.org/apollo/V21N27E10E-thm.png)        |
| 0x06 | V21 N27E 0E               | 终止后台自检。                                               | 无                                                           |

以上为基本启动流程，当然目前我们关注的仅仅只是AGC本身。具体的任务场景还没有启动，而且该项目并不是一个模拟游戏。

# 在轨道太空飞行模拟系统中使用AGC

通过阿波罗计划的NASSP组件，你可以将AGC加入**[Orbiter Space Flight Simulator 2016 Edition](http://orbit.medphys.ucl.ac.uk/download.html)**中进行使用，这是一个免费开源的模拟系统，在该项目中我将AGC下层接口与NASSP组件进行了对接。NASSP源代码组件在项目**NASSP_Source**目录下，该组件使用CMake进行编译。当然，在该目录下的BinaryInstall目录下存储了一份已经编译好的版本，解压后即可加入Orbiter进行运行。



